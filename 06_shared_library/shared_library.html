<!DOCTYPE html>
<html>

<head>
    <title>Shared Library Operators in Dora</title>
    <meta charset="utf-8">
    <style>
        @font-face {
            font-family: 'Carlito';
            src: url('../fonts/Carlito.woff2') format('woff2');
            font-weight: 400;
            font-style: normal;
        }

        @font-face {
            font-family: 'Carlito';
            src: url('../fonts/Carlito-Bold.woff2') format('woff2');
            font-weight: 700;
            font-style: normal;
        }

        @font-face {
            font-family: 'Carlito';
            src: url('../fonts/Carlito-Italic.woff2') format('woff2');
            font-weight: normal;
            font-style: italic;
        }

        @font-face {
            font-family: 'Iosevka Web';
            font-display: swap;
            font-weight: 400;
            font-stretch: normal;
            font-style: normal;
            src: url('../fonts/iosevka-regular.woff2') format('woff2');
        }

        @font-face {
            font-family: 'Carlito';
            src: url('../fonts/Carlito-BoldItalic.woff2') format('woff2');
            font-weight: 700;
            font-style: italic;
        }

        @font-face {
            font-family: 'Bebas Neue';
            src: url('../fonts/BebasNeueRegular.woff2') format('woff2');
            font-weight: 400;
            font-style: normal;
        }

        @font-face {
            font-family: 'Bebas Neue';
            src: url('../fonts/BebasNeueBold.woff2') format('woff2');
            font-weight: 700;
            font-style: normal;
        }

        @font-face {
            font-family: 'Iosevka Web';
            font-display: swap;
            font-weight: 400;
            font-stretch: normal;
            font-style: italic;
            src: url('../fonts/iosevka-italic.woff2') format('woff2');
        }

        @font-face {
            font-family: 'Iosevka Web';
            font-display: swap;
            font-weight: 700;
            font-stretch: normal;
            font-style: normal;
            src: url('../fonts/iosevka-bold.woff2') format('woff2');
        }

        @font-face {
            font-family: 'Iosevka Web';
            font-display: swap;
            font-weight: 700;
            font-stretch: normal;
            font-style: italic;
            src: url('../fonts/iosevka-bolditalic.woff2') format('woff2');
        }

        body {
            font-family: 'Carlito';
        }

        .remark-slide-content {
            padding: 1rem 4rem 1rem 4rem;
        }

        .middle-slide {
            font-size: 25px;
        }

        h1,
        h2,
        h3 {
            font-family: 'Carlito';
            font-weight: bold;
        }

        .remark-slide-content h1 {
            margin-top: 1rem;
            font-size: 4rem;
            margin-bottom: 2rem;
        }

        .remark-code,
        .remark-inline-code {
            font-family: 'Iosevka Web', Iosevka, monospace;
        }

        .title-slide,
        .final-slide {
            color: #000;
        }

        .title-slide .remark-slide-number,
        .final-slide .remark-slide-number {
            visibility: hidden;
        }

        .title-slide h1 {
            font-weight: bold;
            text-transform: uppercase;
            font-family: 'Bebas Neue';
            font-size: 96pt;
            margin-top: 1.5rem;
        }

        .title-slide h2 {
            font-size: 3.5rem;
            margin-bottom: 0rem;
            margin-top: 1rem;
        }

        .title-slide .author-info {
            position: absolute;
            bottom: 2rem;
            font-size: 1.5rem;
        }

        .final-slide h1 {
            margin-top: 1.5rem;
            font-size: 6rem;
        }

        li {
            margin-top: 0.5rem;
        }

        li p:first-child {
            margin-top: 0rem;
        }

        li p {
            margin-bottom: 0rem;
        }

        li pre {
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .remark-slide-number {
            right: 2rem;
        }

        .footer {
            position: absolute;
            opacity: 0.5;
            bottom: 12px;
            left: 4rem;
            font-size: 1rem;
            line-height: 1.8;
            text-align: left;
        }

        .right-column {
            width: 25%;
            float: right;
            display: block;
            font-size: 0.8em;
            margin-left: 2rem;
        }

        .right-column figure {
            margin: 0rem;
        }

        .right-column img {
            max-width: 100%;
        }

        .right-column figcaption {
            font-style: italic;
            font-size: 0.8em;
            color: #555;
        }

        .right-column h3 {
            margin-bottom: 0rem;
            font-size: 1.2em;
        }

        .right-column> :first-child {
            margin-top: 0rem;
        }

        .footnotes,
        .footnotes a {
            color: #666;
        }

        .right-column ol {
            margin-top: 0.5rem;
        }

        code,
        .code {
            font-family: 'Iosevka';
        }

        .footnote {
            color: gray;
            font-size: 0.6em;
            vertical-align: super;
            position: relative;
            padding-left: 0.2rem;
            padding-top: -5rem;
        }

        .footnote::before {
            content: '['
        }

        .footnote::after {
            content: ']'
        }

        .gray {
            color: gray;
        }

        .green-border {
            border: 2px solid green;
        }

        .green-border td {
            border-left: 2px solid green;
            min-width: 3rem;
            text-align: center;
        }

        .green-border td:first-child {
            border-left: none;
        }

        .pass-data-check {
            height: .9em;
            vertical-align: -0.2rem;
        }
    </style>
</head>

<body>
    <textarea id="source">

class: title-slide

# Shared Libraries Operators in Dora

## Creating, linking, calling into shared libraries

<div class="author-info">
    Philipp Oppermann<br>
    os2edu<br>
    2023-11-17
</div>

---

name: middle-slide
layout: true
class: middle-slide
<div class="footer">Shared Library Operators in Dora, Philipp Oppermann, os2edu, 2023-11-17</div>

---


# Agenda

- Background: Executables and libraries
- Motivation: Operators in Dora
  - load operators at runtime into same address space
  - enable function calls between operator and dora runtime

  - Background
  -
  - Linking
  - Shared libraries
  - linking at load time vs at runtime
- Creating shared libraries in C and Rust
- Linking shared libraries
  - at load time -> build script + linker flags
  - at runtime
- Creating bindings
  - bindgen
  - type safety

---

# Executables and Libraries

- Executables are programs with a main function
- Libraries provide callable functions to executable and other libraries
    - e.g. Rust crates can use libraries through a `[dependencies]` section in their `Cargo.toml` file
    - typical file endings of libraries are `.a`, `.lib`, `.so`, `.dll`

--




**Example:** Use `readelf` to read type of ELF files:

```
❯ readelf --file-header /usr/bin/ls | grep "Type"
  Type:                              DYN (Position-Independent `Executable file`)
❯ readelf --file-header /usr/lib32/libc.so.6 | grep "Type"
  Type:                              DYN (`Shared object file`)
```

---

# C Example

- `executable.c`:
    ```c
    #include <stdio.h>
    void main() {
        printf("hello world");
    }
    ```
    - create executable: **`gcc -o executable executable.c`**
    - run executable: `./executable`  →  prints "hello world"
--
- `sum.c`:
    ```c
    int sum(const int a, const int b) {
        return a + b;
    }
    ```
    - try to build as executable using `gcc -o sum sum.c`  →  error: undefined reference to `main'
    - create object file: **`gcc -c sum.c`**
    - then create static library: **`ar r libsum.a sum.o`**

---

# C Example: Using static library

- Use `libsum.a` in `executable.c`:
    - define header file with function signature in `sum.h`:
        ```h
        int sum(const int a, const int b);
        ```
    - include `sum.h` in executable:
        ```c
        #include <stdio.h>
        #include `"sum.h"`

        void main() {
            printf("hello world %i", `sum(40, 2)`);
        }
        ```
    - create executable, linking `libsum.a`:  **`gcc -o executable executable.c -L. -lsum`**
    - run executable: `./executable`  →  prints "hello world 42"

---

# Rust Example

- Executable using cargo:
    ```bash
    ❯ cargo new --bin executable
     Created binary (application) 'executable' package
    ❯ cd executable
    ❯ cargo build
       Compiling executable v0.1.0 (/../executable)
        Finished dev [unoptimized + debuginfo] target(s) in 0.13s
    ❯ target/debug/executable
    Hello, world!
    ```
--
- Library using cargo:
    - create: `cargo new --lib sum`
    - modify `src/lib.rs`:
        ```rust
        pub fn sum(left: usize, right: usize) -> usize {
            left + right
        }
        ```
    - build using `cargo build`  →  creates `target/debug/libsum.rlib` library


---

# Rust Example: Using Rust library

- Using `libsum.rlib` in `executable` crate:
    - add dependency in `executable/Cargo.toml`:
        ```toml
        [dependencies]
        sum = { path = "../sum" }
        ```
    - use `sum` function in `executable/src/main.rs`:
        ```rust
        use sum::sum;

        fn main() {
            println!("Hello, world! {}", sum(40, 2));
        }
        ```
    - rebuild using `cargo build`
    - run `target/debug/executable`  →  outputs _"Hello, world! 42"_

**Note**: [`rlib` libraries](https://rustc-dev-guide.rust-lang.org/backend/libs-and-metadata.html#rlib) are Rust-specific and might change over time
---


# Operators in Dora

- Dora operators are components that can be executed by the Dora runtime
    - act as nodes in the dataflow graph → receive inputs and send outputs
    - a single Dora runtime process can run multiple operators concurrently
- Operators are **libraries** that implement a specific template
    - e.g. they need to provide an **`on_event`** function

--

**Challenge:**

- We don't want to recompile the Dora runtime when loading operators
- `.a` and `.rlib` libraries need to be included at compile time

→ we need to use a different library format that can be loaded without recompiling

---

# Python Libraries

- Python is an interpreted language → no precompiled code
- Rust-based Dora runtime can import Python operators using `pyo3` crate, e.g.:
   ```rust
    Python::with_gil(|py| {
        let sum = PyModule::from_code(py, "
            `def sum(x, y):`
                `return x + y`
        ", "sum.py", "sum")?;

        let result: i32 = sum.getattr(`"sum"`)?.call2(`(40, 2)`)?.extract()?;
        assert_eq!(result, 42);

        Ok(())
    })
   ```
- `pyo3` returns errors when operator has wrong format, e.g. is missing a required function

→ we want something similar for compiled languages: **shared libraries**

---

# Shared libraries

- Approach
  - Precompile library as before, but include additional metadata
  - Compile executable against stub library that describes the template
  - When executable is loaded, combine compiled executable and library using the metadata
- Supported and used on all major OS platforms, but different format:
    - Linux: `.so`
    - Windows: `.dll`
    - MacOS: `.dylib`

---

# Example: C Shared library

TODO

- create
- link
- load

---

# Example: Rust Shared library

TODO

- create
- link
- load
    - c compatibility
- bindgen

---

# Rust Example: Bindgen

TODO

---


# Shared libraries: Pros and Cons

Advantages:
- Avoid duplication of common libraries
  - Both on disk and after loading in RAM
  - Example: TODO common C library
- Security: Updating a shared library fixes all executables
  - Example: SSL libraries TODO
- Platform-specific libraries
  - Example: glibc, system libraries on Windows TODO

Drawbacks:

- Program might not work when when library is missing or at wrong version
- Distribution is more difficult

---

# Dynamic linking

- at load time
- from system paths
  - override possible using manifests (Windows) or env var (Linux) TODO

---

# Example: Load errors in C Shared library

TODO

- provoke load error


---

# Shared library operators in dora

Challenges:
- The dora runtime is compiled ahead of time
  - We don't have access to the operator
- The dora runtime might be linked with multiple operators
- We want good error messages


-> use dynamic loading to link library manually at runtime

---

# Dynamic Loading

- load library through explicit runtime operation
- more resilient -> better error messages
- drawback: less convenient, more manual work necessary

---

# Dynamic Loading in Rust

TODO

---

# Safety and type checking

TODO

---

class: final-slide

# Summary



    </textarea>
    <script src="../remark-latest.min.js"></script>
    <script>
        var slideshow = remark.create({
            ratio: '16:9',
            navigation: {
                scroll: false
            },
            slideNumberFormat: '%current%',
            highlightLines: true,
            highlightSpans: true,
            countIncrementalSlides: false,
        });
    </script>
</body>

</html>
